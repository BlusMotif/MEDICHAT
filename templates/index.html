{% extends 'base.html' %}

{% block title %}Medi Chat - Your Personal Medical Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-lg border-0 fade-in mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Medi Chat</h4>
            </div>
            <div class="card-body">
                <!-- Chat messages container -->
                <div class="chat-container" id="chatContainer">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <!-- Typing indicator -->
                <div class="bot-message typing-indicator-container d-none" id="typingIndicator">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <!-- Input form -->
                <form id="chatForm" class="mt-3">
                    <div class="input-group">
                        <input type="text" id="userMessage" class="form-control" placeholder="Type your symptoms here..." required>
                        <button type="submit" class="btn btn-primary pulse-animation">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </form>
                
                <!-- Reset conversation button -->
                <div class="text-center mt-3">
                    <button id="resetConversation" class="btn btn-outline-secondary btn-sm pulse-animation">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset Conversation
                    </button>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex align-items-center">
                    <div>
                        <span class="badge bg-info">Info</span> Please describe at least 3 symptoms for accurate assessment.
                    </div>
                    <div class="ms-auto">
                        {% if current_user.is_authenticated %}
                            <small class="text-muted">Logged in as: {{ current_user.username }}</small>
                        {% else %}
                            <small><a href="{{ url_for('login') }}">Login</a> to save your chat history</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Information cards -->
        <div class="row fade-in">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Symptom Analysis</h5>
                        <p class="card-text">Our system analyzes your symptoms using advanced natural language processing to identify potential health conditions.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Medical Knowledge</h5>
                        <p class="card-text">Powered by comprehensive medical data covering a wide range of health conditions and their symptoms.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Treatment Information</h5>
                        <p class="card-text">Get information about potential treatments for identified conditions, always consult a healthcare professional.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const userMessage = document.getElementById('userMessage');
        const resetButton = document.getElementById('resetConversation');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // Function to add message to the chat
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
            
            if (sender === 'bot') {
                messageDiv.innerHTML = formatBotMessage(message);
            } else {
                messageDiv.textContent = message;
            }
            
            // Add timestamp
            const timestamp = document.createElement('div');
            timestamp.className = 'message-time';
            timestamp.textContent = getFormattedTime();
            messageDiv.appendChild(timestamp);
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Format bot message (process HTML)
        function formatBotMessage(message) {
            return message;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.classList.remove('d-none');
            chatContainer.appendChild(typingIndicator);
            scrollToBottom();
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.classList.add('d-none');
        }
        
        // Get formatted time
        function getFormattedTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            
            return `${hours}:${minutes} ${ampm}`;
        }
        
        // Scroll chat to bottom
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Send message to server
        function sendMessage(message) {
            fetch('/get_response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                addMessage(data.response, 'bot');
            })
            .catch(error => {
                hideTypingIndicator();
                addMessage('Sorry, there was an error processing your request. Please try again.', 'bot');
                console.error('Error:', error);
            });
        }
        
        // Handle form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = userMessage.value.trim();
            
            if (message) {
                addMessage(message, 'user');
                userMessage.value = '';
                showTypingIndicator();
                sendMessage(message);
            }
        });
        
        // Handle reset button
        resetButton.addEventListener('click', function() {
            fetch('/reset_conversation', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    chatContainer.innerHTML = '';
                    addMessage('Conversation has been reset. How can I help you today?', 'bot');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
        
        // Initial greeting
        sendMessage('');
    });
</script>
{% endblock %}